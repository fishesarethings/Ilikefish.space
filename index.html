<!DOCTYPE html>
<html lang="en">
<head>

  <meta http-equiv="Strict-Transport-Security" content="max-age=31536000; includeSubDomains; preload">

  <!-- Consent blocker — prevent analytics/ads from loading until user gives consent -->
  <script>
    // keep GA disabled until explicit consent
    window['ga-disable-G-ZV53VVVSK3'] = true;
    // vendor loaded flags
    window.__ilf_vendor_loaded = window.__ilf_vendor_loaded || false;
    window.__ilf_ads_loaded = window.__ilf_ads_loaded || false;
  </script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <meta name="title" content="ILikeFish.Space – Free Browser Games to Play Online or Offline">
  <meta name="description" content="Play free mini-games instantly at ILikeFish.Space. Works in your browser, offline, or download locally for endless fun anywhere.">
  <meta name="keywords" content="mini games, browser games, free games, HTML5 games, offline games, downloadable games, casual games, ILikeFish">
  <meta name="author" content="fishesarethings">

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://ilikefish.space/">
  <meta property="og:title" content="ILikeFish.Space – Free Games to Play Online or Offline">
  <meta property="og:description" content="Quick, fun, and free mini-games. Play instantly in your browser, offline, or download locally to enjoy anytime.">
  <meta property="og:image" content="https://ilikefish.space/assets/img/bg-home.jpg">
  <meta property="og:site_name" content="ILikeFish.Space">

  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://ilikefish.space/">
  <meta property="twitter:title" content="ILikeFish.Space – Free Games to Play Online or Offline">
  <meta property="twitter:description" content="Play casual mini-games instantly, offline, or download them to keep forever. Free fun at ILikeFish.Space.">
  <meta property="twitter:image" content="https://ilikefish.space/assets/img/bg-home.jpg">

  <title>I like fishes _</title>
  <link rel="icon" href="/assets/img/ilikefishes-500px.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/img/ilikefishes-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/img/ilikefishes-16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/img/ilikefishes-180.png">
  <meta name="theme-color" content="#0b0f14">
  <link rel="manifest" href="/manifest.json">

  <!-- Core CSS -->
  <link rel="stylesheet" href="/assets/css/styles.css">
  <!-- Locomotive & AOS CSS -->
  <link rel="stylesheet" href="https://unpkg.com/locomotive-scroll/dist/locomotive-scroll.css">
  <link rel="stylesheet" href="https://unpkg.com/aos@2.3.4/dist/aos.css">

  <!-- Chart.js (non-tracking lib) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
  <!-- Locomotive, AOS libraries -->
  <script src="https://unpkg.com/locomotive-scroll/dist/locomotive-scroll.min.js" defer></script>
  <script src="https://unpkg.com/aos@2.3.4/dist/aos.js" defer></script>

  <!-- Local scripts (deferred) -->
  <script src="/assets/js/loco.js" defer></script>
  <script src="/assets/js/sw-register.js" defer></script>
  <script src="/assets/js/typing.js" defer></script>
  <script src="/assets/js/graphs.js" defer></script>
  <script src="/assets/js/version-check.js" defer></script>

  <link rel="canonical" href="https://ilikefish.space/">

  <!-- Structured data: Website-level search action -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "ILikeFish.Space",
    "url": "https://ilikefish.space/",
    "description": "Play free browser-based mini-games instantly, offline, or download them locally. Casual fun for everyone at ILikeFish.Space.",
    "publisher": {
      "@type": "Organization",
      "name": "fishesarethings",
      "url": "https://ilikefish.space/"
    },
    "potentialAction": {
      "@type": "SearchAction",
      "target": "https://ilikefish.space/games.html?q={search_term_string}",
      "query-input": "required name=search_term_string"
    }
  }
  </script>

  <style>
    /* center modal (old style) */
    .modal-backdrop {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center;
      z-index: 2000;
    }
    .modal {
      background: #fff; color: #000; padding: 1.3rem; border-radius: 8px;
      max-width: 440px; width: 92%; position: relative; text-align: center;
      box-shadow: 0 18px 60px rgba(0,0,0,0.24);
    }
    .modal h2 { margin-top: 0; font-size: 1.05rem; }
    .modal .close { position: absolute; top: 8px; right: 12px; background: none; border: none; font-size: 1.25rem; cursor: pointer; }
    .modal button { margin: .45rem; padding: .45rem .9rem; border-radius:6px; cursor:pointer; }

    /* small refresh button appearance */
    #check-update { margin-left:.5rem; padding:.18rem .5rem; font-size:.9em; border-radius:6px; border:1px solid #ddd; background:#fff; cursor:pointer; }
    #check-update.btn-disabled { opacity:.5; pointer-events:none; filter:grayscale(10%); }
    .update-badge { display:inline-block; margin-left:.4rem; background:#e53935; color:#fff; padding:.12rem .5rem; border-radius:8px; font-weight:700; font-size:.75rem; }

    /* make hero occupy whole viewport (old behaviour) */
    .hero.first { background-image:url('/assets/img/bg-home.jpg'); background-size:cover; background-position:center; height:100vh; display:flex; align-items:center; justify-content:center; }

    /* ---- Added styles for export button (only new CSS) ---- */
    .export-backup-wrapper { display:flex; justify-content:center; padding:18px 12px; background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(250,250,252,0.9)); }
    .export-backup { display:flex; gap:12px; align-items:center; max-width:980px; width:100%; justify-content:center; }
    .export-btn {
      padding: 12px 18px;
      border-radius: 12px;
      font-weight: 700;
      background: linear-gradient(90deg,#007aff,#0057d9);
      color: #fff;
      border: none;
      box-shadow: 0 10px 28px rgba(3,22,55,0.12);
      cursor: pointer;
      font-size: 0.98rem;
      transition: transform .12s ease, box-shadow .12s ease, opacity .12s ease;
      white-space: nowrap;
    }
    .export-btn:hover { transform: translateY(-2px); box-shadow: 0 14px 36px rgba(3,22,55,0.16); }
    .export-btn:disabled { opacity: .7; cursor: default; transform:none; box-shadow: none; }

    /* ---- Added styles for import button (matches export button) ---- */
    .import-btn {
      padding: 12px 18px;
      border-radius: 12px;
      font-weight: 700;
      background: linear-gradient(90deg,#00c853,#007e33);
      color: #fff;
      border: none;
      box-shadow: 0 10px 28px rgba(3,22,55,0.12);
      cursor: pointer;
      font-size: 0.98rem;
      transition: transform .12s ease, box-shadow .12s ease;
      white-space: nowrap;
    }
    .import-btn:hover { transform: translateY(-2px); box-shadow: 0 14px 36px rgba(3,22,55,0.16); }
    .import-btn:disabled { opacity:.7; cursor:default; transform:none; box-shadow:none; }

    @media (max-width:560px) {
      .export-backup { flex-direction: column; gap:10px; padding:6px 6px; }
      .export-btn { width:100%; text-align:center; padding:10px 14px; font-size:0.95rem; }
      .import-btn { width:100%; text-align:center; padding:10px 14px; font-size:0.95rem; }
    }
  </style>
</head>
<body data-scroll-container>
  <script>window.addEventListener('load',()=>AOS.init({duration:800,once:true}));</script>

  <!-- Navigation -->
  <nav data-aos="fade-down">
    <ul>
      <li><a href="/index.html">Home</a></li>
      <li><a href="/games.html">Games</a></li>
      <li><a href="/gamepack.html">Game Package</a></li>
    </ul>
  </nav>

  <!-- Hero - full viewport. Text preserved exactly with trailing space. -->
  <section class="hero first" data-scroll-section data-aos="fade-up">
    <h1 id="hero-title" class="typewriter">I like fishes </h1>
  </section>

  <!-- Featured Games (below the fold) -->
  <section class="section-interactive" data-scroll-section data-aos="fade-up" style="background-image:url('/assets/img/bg-games.jpg');">
    <h2 data-scroll data-scroll-speed="2">Featured Games</h2>
    <div id="featured-games" class="cards-container"></div>
  </section>

  <!-- EXPORT BUTTON (inserted below Featured Games and above All Games) -->
  <section class="export-backup-wrapper" data-scroll-section data-aos="fade-up" aria-hidden="false">
    <div class="export-backup">
      <button id="export-progress-btn" class="export-btn" aria-label="Export game progress">
        To make sure all game progress is safe export regually
      </button>

      <!-- Import button added beside Export -->
      <button id="import-progress-btn" class="import-btn" aria-label="Import game progress">
        Import backup (localStorage / IndexedDB)
      </button>
    </div>
  </section>

  <!-- All Games -->
  <section class="section-interactive" data-scroll-section data-aos="fade-up" style="background-image:url('/assets/img/bg-games.jpg');">
    <h2 data-scroll data-scroll-speed="1">All Games</h2>
    <div id="all-games" class="cards-container"></div>
  </section>

  <script src="/assets/js/games-list.js" defer></script>

  <!-- bottom download notification -->
  <div id="download-progress"><div class="bar"></div></div>
  <div id="download-complete">Download complete!</div>

  <!-- Server teaser: graph and join button inside the same .box for contrast -->
  <section class="section-interactive" data-scroll-section data-aos="fade-up" style="background-image:url('/assets/img/bg-server.jpg');">
    <h2 data-scroll data-scroll-speed="2">Our Minecraft Server</h2>

    <div class="box">
      <label>Join Address</label>
      <div class="copy-box">
        <span id="address">mc.ilikefish.space</span>
        <button onclick="copyText('mc.ilikefish.space')">Copy</button>
      </div>

      <label>Port</label>
      <div class="copy-box">
        <span id="port">5850</span>
        <button onclick="copyText('5850')">Copy</button>
      </div>

      <label>Ping</label>
      <div class="copy-box">
        <div class="ring-container">
          <div class="ringring"></div>
          <div class="circle"></div>
        </div>
        <span id="ping">-- ms</span>
        <button id="refresh-ping">↻</button>
      </div>

      <label>Timeframe</label>
      <div class="copy-box">
        <select id="range-select">
          <option value="3600000">Last 1 Hour</option>
          <option value="86400000" selected>Last 24 Hours</option>
          <option value="604800000">Last 1 Week</option>
          <option value="2592000000">Last 1 Month</option>
          <option value="31536000000">Last 1 Year</option>
        </select>
        <button id="update-graph" class="btn-disabled">Update Graph</button>
      </div>

      <div class="quick-join" style="margin-top:1rem;">
        <p style="color:#111; margin-bottom:0.75em;">Too lazy to copy IP and port? Try this button—it may or may not work.<br>
           (Server name: <strong>mc.ilikefish.space</strong>)</p>
        <a
          class="join-button"
          href="minecraft://?addExternalServer=mc.ilikefish.space|mc.ilikefish.space:5850"
          style="display:inline-block;padding:0.65em 1.25em;border-radius:8px;font-size:1em;text-decoration:none;background:#4CAF50;color:#fff;"
          onmouseover="this.style.background='#45a049';"
          onmouseout="this.style.background='#4CAF50';"
        >🎮 Join mc.ilikefish.space</a>
      </div>

      <div style="margin-top:1rem;">
        <canvas id="activityChart" style="width:100%;height:320px;"></canvas>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer style="text-align:center;padding:1rem;color:#666;font-size:.8rem; position: relative;">
    <p>Site Version: <span id="current-site-version">—</span>
      <button id="check-update" class="btn-disabled" aria-label="Check for updates">🔄 Refresh</button>
    </p>
    <p>
      Dedicated to the public domain under the
      <a href="https://unlicense.org/" target="_blank" rel="noopener noreferrer">Unlicense</a>.<br>

      © 2025 fishesarethings — No rights reserved.
      <a href="/terms.html">Terms & Conditions</a> •
      <a href="#" id="cookie-settings-link">Cookie settings</a>
    </p>
  </footer>

  <!-- Modal for version update (centered) -->
  <div id="modal-backdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" id="modal">
      <button class="close" id="modal-close" aria-label="Close">&times;</button>
      <h2 id="modal-title"></h2>
      <p id="modal-message"></p>
      <div id="modal-buttons"></div>
    </div>
  </div>

  <!-- Core Scripts -->
  <script src="/assets/js/server.js" defer></script>
  <script src="/assets/js/fullscreen.js" defer></script>

  <!-- Export button script (only new JS) -->
  <script>
    // Export localStorage and IndexedDB (best-effort) when user clicks the export button.
    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('export-progress-btn');
      if (!btn) return;

      btn.addEventListener('click', async () => {
        try {
          btn.disabled = true;
          const originalText = btn.textContent;
          btn.textContent = 'Exporting...';

          // 1) Export localStorage
          try {
            const ls = {};
            for (let i = 0; i < localStorage.length; i++) {
              const k = localStorage.key(i);
              ls[k] = localStorage.getItem(k);
            }
            const blobLS = new Blob([JSON.stringify(ls, null, 2)], { type: 'application/json' });
            const urlLS = URL.createObjectURL(blobLS);
            const a1 = document.createElement('a');
            a1.href = urlLS;
            a1.download = 'ilikefish-localStorage-backup.json';
            document.body.appendChild(a1);
            a1.click();
            a1.remove();
            URL.revokeObjectURL(urlLS);
          } catch (e) {
            console.error('localStorage export failed', e);
          }

          // 2) Export IndexedDB (best-effort)
          try {
            if (indexedDB && indexedDB.databases) {
              const dbs = await indexedDB.databases();
              const out = {};
              for (const info of dbs) {
                const name = info.name;
                if (!name) continue;
                out[name] = {};
                await new Promise((resolve) => {
                  const req = indexedDB.open(name);
                  req.onsuccess = () => {
                    const db = req.result;
                    const storeNames = Array.from(db.objectStoreNames || []);
                    if (storeNames.length === 0) { db.close(); resolve(); return; }
                    const tx = db.transaction(storeNames, 'readonly');
                    Promise.all(storeNames.map(sname => new Promise(r2 => {
                      const items = [];
                      try {
                        const store = tx.objectStore(sname);
                        const cursorReq = store.openCursor();
                        cursorReq.onsuccess = ev => {
                          const cursor = ev.target.result;
                          if (cursor) { items.push(cursor.value); cursor.continue(); }
                          else { out[name][sname] = items; r2(); }
                        };
                        cursorReq.onerror = () => { out[name][sname] = null; r2(); };
                      } catch (ee) {
                        out[name][sname] = null;
                        r2();
                      }
                    }))).then(() => { db.close(); resolve(); });
                  };
                  req.onerror = () => { resolve(); };
                });
              }
              const blobDB = new Blob([JSON.stringify(out, null, 2)], { type: 'application/json' });
              const urlDB = URL.createObjectURL(blobDB);
              const a2 = document.createElement('a');
              a2.href = urlDB;
              a2.download = 'ilikefish-indexeddb-backup.json';
              document.body.appendChild(a2);
              a2.click();
              a2.remove();
              URL.revokeObjectURL(urlDB);
            } else {
              // Some browsers don't support indexedDB.databases(); inform via console only.
              console.warn('indexedDB.databases() not supported — cannot export IndexedDB programmatically in this browser.');
            }
          } catch (e) {
            console.error('IndexedDB export failed', e);
          }

          btn.textContent = 'Export complete — check downloads';
          setTimeout(() => {
            btn.textContent = originalText;
            btn.disabled = false;
          }, 2500);
        } catch (err) {
          console.error('Export routine failed', err);
          btn.disabled = false;
          btn.textContent = 'Export failed — try again';
          setTimeout(() => { btn.textContent = 'To make sure all game progress is safe export regually'; }, 2200);
        }
      });
    });
  </script>

  <!-- Import button script (new JS) -->
  <script>
    // Import localStorage and IndexedDB backups (best-effort) when user clicks the import button.
    document.addEventListener('DOMContentLoaded', () => {
      const importBtn = document.getElementById('import-progress-btn');
      if (!importBtn) return;

      // create a hidden file input for selecting the backup JSON
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = '.json,application/json';
      fileInput.style.display = 'none';
      document.body.appendChild(fileInput);

      function readFile(file) {
        return new Promise((res, rej) => {
          const r = new FileReader();
          r.onload = () => res(r.result);
          r.onerror = () => rej(r.error);
          r.readAsText(file);
        });
      }

      function isLikelyLocalStorage(obj) {
        if (!obj || typeof obj !== 'object') return false;
        const keys = Object.keys(obj);
        if (keys.length === 0) return false;
        return keys.every(k => typeof obj[k] === 'string');
      }

      function deleteDatabase(name) {
        return new Promise((resolve) => {
          try {
            const del = indexedDB.deleteDatabase(name);
            del.onsuccess = () => resolve();
            del.onerror = () => resolve();
            del.onblocked = () => resolve();
          } catch (e) {
            resolve();
          }
        });
      }

      function createAndPopulateDB(name, storesObj) {
        return new Promise((resolve) => {
          const req = indexedDB.open(name, 1);
          req.onupgradeneeded = (e) => {
            const db = e.target.result;
            for (const storeName of Object.keys(storesObj)) {
              if (!db.objectStoreNames.contains(storeName)) {
                try { db.createObjectStore(storeName, { autoIncrement: true }); } catch (e) {}
              }
            }
          };
          req.onsuccess = async (e) => {
            const db = e.target.result;
            try {
              for (const [storeName, items] of Object.entries(storesObj)) {
                if (!db.objectStoreNames.contains(storeName)) continue;
                const tx = db.transaction(storeName, 'readwrite');
                const store = tx.objectStore(storeName);
                for (const item of (Array.isArray(items) ? items : [])) {
                  try { store.put(item); } catch (e) { /* ignore item */ }
                }
                await new Promise(r => { tx.oncomplete = () => r(); tx.onabort = tx.onerror = () => r(); });
              }
            } catch (e) { /* swallow */ }
            db.close();
            resolve();
          };
          req.onerror = () => resolve();
        });
      }

      importBtn.addEventListener('click', () => {
        fileInput.value = '';
        fileInput.click();
      });

      fileInput.addEventListener('change', async (ev) => {
        const file = ev.target.files && ev.target.files[0];
        if (!file) return;
        importBtn.disabled = true;
        const originalText = importBtn.textContent;
        importBtn.textContent = 'Importing...';

        try {
          const text = await readFile(file);
          let parsed;
          try { parsed = JSON.parse(text); } catch (e) {
            alert('Import failed: file is not valid JSON.');
            importBtn.disabled = false;
            importBtn.textContent = originalText;
            return;
          }

          if (isLikelyLocalStorage(parsed) || file.name.toLowerCase().includes('localstorage')) {
            if (!confirm('This will write keys from the backup into localStorage and may overwrite existing keys. Continue?')) {
              importBtn.disabled = false;
              importBtn.textContent = originalText;
              return;
            }
            let count = 0;
            for (const [k, v] of Object.entries(parsed)) {
              try { localStorage.setItem(k, String(v)); count++; } catch (e) {}
            }
            alert('localStorage import complete — set ' + count + ' keys. Reload the page to apply changes.');
          } else {
            const dbNames = Object.keys(parsed);
            if (dbNames.length === 0) {
              alert('Import JSON contains no databases.');
            } else {
              if (!confirm('This will recreate the following IndexedDB database(s):\n\n' + dbNames.join('\n') + '\n\nThe existing databases with those names will be deleted first (recommended). Continue?')) {
                importBtn.disabled = false;
                importBtn.textContent = originalText;
                return;
              }
              for (const dbName of dbNames) {
                try { await deleteDatabase(dbName); } catch (e) {}
              }
              for (const dbName of dbNames) {
                const storesObj = parsed[dbName] || {};
                await createAndPopulateDB(dbName, storesObj);
              }
              alert('IndexedDB import complete. Reload the page to apply changes.');
            }
          }
        } catch (err) {
          console.error('Import failed', err);
          alert('Import failed — check console for details.');
        } finally {
          importBtn.disabled = false;
          importBtn.textContent = originalText;
        }
      });
    });
  </script>

  <!-- Cookie consent UI & logic (loads GA / AdSense on consent) -->
  <style id="ilf-cookie-style">
  /* Banner */
  #ilf-cookie-banner {
    position: fixed;
    left: 50%;
    bottom: 24px;
    transform: translateX(-50%);
    max-width: 920px;
    width: calc(100% - 40px);
    background: rgba(255,255,255,0.98);
    box-shadow: 0 8px 30px rgba(3,22,55,0.12);
    border-radius: 12px;
    padding: 16px 18px;
    display: none;
    align-items: center;
    gap: 12px;
    z-index: 99999;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    color: #0b0f14;
  }
  #ilf-cookie-banner .ilf-text { flex: 1; font-size: 14px; line-height: 1.4; }
  #ilf-cookie-banner .ilf-text a { color: #007aff; text-decoration: none; font-weight:600; }
  #ilf-cookie-banner .ilf-actions { display:flex; gap:10px; align-items:center; }

  .ilf-btn { padding: 10px 14px; border-radius: 10px; border: none; cursor: pointer; font-weight: 700; font-size: 13px; }
  .ilf-btn-accept { background: linear-gradient(90deg,#007aff,#0057d9); color: #fff; }
  .ilf-btn-reject { background: transparent; border:1px solid #ddd; color:#111; }
  .ilf-btn-manage { background:#fff; color:#111; border:1px solid #e6e6e9; }

  #ilf-cookie-modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.45); display:none; align-items: center; justify-content:center; z-index:100000; }
  #ilf-cookie-modal { width: 92%; max-width: 720px; background:#fff; border-radius:12px; padding:20px; box-shadow:0 20px 60px rgba(3,22,55,0.16); font-size:14px; }
  #ilf-cookie-modal h3 { margin: 0 0 8px; font-size: 18px; color:#0b0f14; }
  #ilf-cookie-modal p { margin:0 0 12px; color:#444; }
  .ilf-preference { display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-top:1px solid #f5f5f7; }
  .ilf-preference:first-of-type { border-top: none; }
  .switch { --w:46px; --h:26px; width:var(--w); height:var(--h); background:#e9ecef; border-radius:999px; position:relative; cursor:pointer; }
  .switch .knob { position:absolute; top:3px; left:3px; width:20px; height:20px; background:#fff; border-radius:50%; box-shadow:0 2px 6px rgba(3,22,55,0.08); transition:left .18s ease; }
  .switch.on { background:#dbeeff; }
  .switch.on .knob { left:calc(var(--w) - 23px); }
  #ilf-cookie-modal .modal-actions { display:flex; gap:10px; justify-content:flex-end; margin-top:14px; }
  @media (max-width:560px){
    #ilf-cookie-banner { padding:12px; bottom:12px; }
    .ilf-text { font-size:13px; }
    .ilf-btn { font-size:13px; padding:9px 11px; }
  }
  </style>

  <div id="ilf-cookie-banner" aria-live="polite">
    <div class="ilf-text">
      By using this site you accept our <a href="/terms.html" target="_blank" rel="noopener noreferrer">Terms & Conditions</a> and usage of data. We use necessary cookies for site functionality. We may use analytics and ads only if you consent. We do not use personalised profiling unless you enable it.
    </div>
    <div class="ilf-actions">
      <button class="ilf-btn ilf-btn-reject" id="ilf-reject-all">Reject</button>
      <button class="ilf-btn ilf-btn-manage" id="ilf-manage">Manage</button>
      <button class="ilf-btn ilf-btn-accept" id="ilf-accept-all">Accept</button>
    </div>
  </div>

  <div id="ilf-cookie-modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div id="ilf-cookie-modal" role="document" aria-labelledby="ilf-modal-title">
      <h3 id="ilf-modal-title">Cookie preferences</h3>
      <p>Choose which cookies you allow. Necessary cookies are required for the website to work.</p>

      <div class="ilf-preference" data-key="necessary">
        <div>
          <strong>Necessary</strong>
          <div style="color:#666;font-size:13px;">Required for basic site functionality</div>
        </div>
        <div style="opacity:.7">Always on</div>
      </div>

      <div class="ilf-preference" data-key="analytics">
        <div>
          <strong>Analytics</strong>
          <div style="color:#666;font-size:13px;">Help us improve by collecting anonymous usage data (Google Analytics)</div>
        </div>
        <div>
          <div class="switch" id="ilf-switch-analytics" role="switch" tabindex="0" aria-checked="false" aria-label="Analytics toggle">
            <div class="knob"></div>
          </div>
        </div>
      </div>

      <div class="ilf-preference" data-key="ads">
        <div>
          <strong>Ads</strong>
          <div style="color:#666;font-size:13px;">Serve ads (non-personalised by default)</div>
        </div>
        <div>
          <div class="switch" id="ilf-switch-ads" role="switch" tabindex="0" aria-checked="false" aria-label="Ads toggle">
            <div class="knob"></div>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button class="ilf-btn ilf-btn-reject" id="ilf-modal-reject">Reject All</button>
        <button class="ilf-btn ilf-btn-manage" id="ilf-modal-save">Save preferences</button>
      </div>
    </div>
  </div>

  <script>
  (function(){
    const KEY = 'ilf_cookie_consent';
    const COOKIE_NAME = 'ilf_cookie_consent';
    const COOKIE_EXPIRE_DAYS = 365;

    function getStored() {
      try {
        const ls = localStorage.getItem(KEY);
        if (ls) return JSON.parse(ls);
        // fallback to cookie:
        const cookie = document.cookie.split('; ').find(r => r.startsWith(COOKIE_NAME+'='));
        if (cookie) {
          const val = decodeURIComponent(cookie.split('=')[1] || '');
          return JSON.parse(val);
        }
        return null;
      } catch (e) { return null; }
    }
    function saveStored(obj) {
      try {
        localStorage.setItem(KEY, JSON.stringify(obj));
        const value = encodeURIComponent(JSON.stringify(obj));
        const expires = new Date(Date.now() + COOKIE_EXPIRE_DAYS*24*60*60*1000).toUTCString();
        document.cookie = COOKIE_NAME + '=' + value + '; path=/; expires=' + expires + '; SameSite=Lax';
      } catch (e) {}
    }

    function hideBanner() { document.getElementById('ilf-cookie-banner').style.display = 'none'; }
    function showBanner() { document.getElementById('ilf-cookie-banner').style.display = 'flex'; }

    function loadGtag() {
      if (window.__ilf_vendor_loaded) return;
      window.__ilf_vendor_loaded = true;
      window['ga-disable-G-ZV53VVVSK3'] = false;
      const s = document.createElement('script');
      s.src = 'https://www.googletagmanager.com/gtag/js?id=G-ZV53VVVSK3';
      s.async = true;
      s.onload = function() {
        window.dataLayer = window.dataLayer || [];
        function gtag(){window.dataLayer.push(arguments);}
        window.gtag = gtag;
        gtag('js', new Date());
        gtag('config', 'G-ZV53VVVSK3', { 'anonymize_ip': true });
      };
      document.head.appendChild(s);
    }

    function loadAdsense() {
      if (window.__ilf_ads_loaded) return;
      window.__ilf_ads_loaded = true;
      const s = document.createElement('script');
      s.src = 'https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9929753961924881';
      s.async = true;
      s.setAttribute('crossorigin','anonymous');
      s.onload = function() {
        try { (window.adsbygoogle = window.adsbygoogle || []).push({}); } catch(e){}
      };
      document.head.appendChild(s);
    }

    function applyConsent(consent) {
      if (!consent) return;
      if (consent.analytics) loadGtag();
      if (consent.ads) loadAdsense();
    }

    const defaultConsent = { necessary: true, analytics: false, ads: false, notice: true, ts: Date.now() };

    const banner = document.getElementById('ilf-cookie-banner');
    const modalBackdrop = document.getElementById('ilf-cookie-modal-backdrop');
    const switchAnalytics = document.getElementById('ilf-switch-analytics');
    const switchAds = document.getElementById('ilf-switch-ads');
    const btnAccept = document.getElementById('ilf-accept-all');
    const btnReject = document.getElementById('ilf-reject-all');
    const btnManage = document.getElementById('ilf-manage');
    const btnModalSave = document.getElementById('ilf-modal-save');
    const btnModalReject = document.getElementById('ilf-modal-reject');
    const cookieSettingsLink = document.getElementById('cookie-settings-link');

    function setSwitch(el, on) {
      if (!el) return;
      if (on) { el.classList.add('on'); el.setAttribute('aria-checked','true'); }
      else { el.classList.remove('on'); el.setAttribute('aria-checked','false'); }
    }

    function openModal() {
      const current = getStored() || defaultConsent;
      setSwitch(switchAnalytics, !!current.analytics);
      setSwitch(switchAds, !!current.ads);
      modalBackdrop.style.display = 'flex';
      modalBackdrop.setAttribute('aria-hidden','false');
      setTimeout(()=> switchAnalytics.focus(), 50);
    }
    function closeModal() {
      modalBackdrop.style.display = 'none';
      modalBackdrop.setAttribute('aria-hidden','true');
    }

    btnAccept.addEventListener('click', () => {
      const consent = { necessary:true, analytics:true, ads:true, notice:false, ts: Date.now() };
      saveStored(consent);
      applyConsent(consent);
      hideBanner();
    });

    btnReject.addEventListener('click', () => {
      const consent = { necessary:true, analytics:false, ads:false, notice:false, ts: Date.now() };
      window['ga-disable-G-ZV53VVVSK3'] = true;
      saveStored(consent);
      hideBanner();
    });

    btnManage.addEventListener('click', openModal);
    cookieSettingsLink && cookieSettingsLink.addEventListener('click', (e)=>{ e.preventDefault(); openModal(); });

    function toggleSwitch(el) {
      const on = !el.classList.contains('on');
      setSwitch(el, on);
    }
    switchAnalytics.addEventListener('click', () => toggleSwitch(switchAnalytics));
    switchAds.addEventListener('click', () => toggleSwitch(switchAds));

    [switchAnalytics, switchAds].forEach(el=>{
      el.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleSwitch(el); }
        else if (e.key === 'Escape') { closeModal(); }
      });
    });

    btnModalReject.addEventListener('click', () => {
      const consent = { necessary:true, analytics:false, ads:false, notice:false, ts: Date.now() };
      window['ga-disable-G-ZV53VVVSK3'] = true;
      saveStored(consent);
      applyConsent(consent);
      closeModal();
      hideBanner();
    });

    btnModalSave.addEventListener('click', () => {
      const consent = {
        necessary: true,
        analytics: switchAnalytics.classList.contains('on'),
        ads: switchAds.classList.contains('on'),
        notice: false,
        ts: Date.now()
      };
      if (consent.analytics) window['ga-disable-G-ZV53VVVSK3'] = false;
      else window['ga-disable-G-ZV53VVVSK3'] = true;
      saveStored(consent);
      applyConsent(consent);
      closeModal();
      hideBanner();
    });

    modalBackdrop.addEventListener('click', (e) => { if (e.target === modalBackdrop) closeModal(); });

    // Initialize: check stored consent
    const stored = getStored();
    if (stored && typeof stored === 'object') {
      applyConsent(stored);
      // hide banner if notice already accepted or a stored preference exists
      if (!stored.notice) hideBanner();
    } else {
      // show banner
      showBanner();
    }

    // Expose small API to change consent programmatically
    window.ilfConsent = {
      get: getStored,
      save: (obj) => { saveStored(obj); applyConsent(obj); },
      reset: () => { saveStored(defaultConsent); window['ga-disable-G-ZV53VVVSK3'] = true; }
    };
  })();
  </script>

  <!-- Init chart + update button -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const defaultRange = 86400000;
      if (typeof window.initActivityChart === 'function') {
        window.initActivityChart('activityChart', defaultRange)
          .then(() => {
            const btn = document.getElementById('update-graph');
            if (btn) btn.classList.remove('btn-disabled');
            btn.addEventListener('click', () => {
              btn.classList.add('btn-disabled');
              btn.textContent = 'Updating...';
              const range = parseInt(document.getElementById('range-select').value, 10) || defaultRange;
              window.updateActivityChart(range).finally(() => {
                btn.textContent = 'Update Graph';
                btn.classList.remove('btn-disabled');
              });
            });
          })
          .catch(err => console.error('Chart init failed:', err));
      }

      // service worker progress listener (bottom notification)
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.ready.then(() => {
          const p = document.getElementById('download-progress');
          const b = p.querySelector('.bar');
          const d = document.getElementById('download-complete');
          navigator.serviceWorker.addEventListener('message', ev => {
            if (ev.data?.type === 'PRECACHE_PROGRESS') {
              p.style.display = 'block';
              b.style.width = ev.data.percent + '%';
              if (ev.data.percent >= 100) {
                p.style.display = 'none';
                d.style.display = 'block';
                setTimeout(() => d.style.display = 'none', 2000);
              }
            }
          });
        }).catch(()=>{});
      }
    });
  </script>
</body>
</html>

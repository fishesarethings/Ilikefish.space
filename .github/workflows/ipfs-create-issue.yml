name: Upload repo root to IPFS (nft.storage) and create Issue with CID

on:
  push:
    branches: [ main ]

env:
  BUILD_DIR: '.'   # repo root

jobs:
  upload:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Optional build (run if package.json has build)
      run: |
        if [ -f package.json ] && grep -q "\"build\"" package.json; then
          npm ci
          npm run build
        fi

    - name: Zip repo root (exclude .git and workflow runs)
      run: |
        rm -f site.zip
        zip -r site.zip . -x "*.git*" ".github/actions/*" "node_modules/*" || true
        ls -lah site.zip

    - name: Upload site.zip to nft.storage
      id: upload
      env:
        NFT_TOKEN: ${{ secrets.NFT_STORAGE_API_KEY }}
      run: |
        if [ -z "$NFT_TOKEN" ]; then echo "Missing NFT_STORAGE_API_KEY secret"; exit 1; fi
        # upload zip to nft.storage and save response
        curl -s -X POST "https://api.nft.storage/upload" \
          -H "Authorization: Bearer $NFT_TOKEN" \
          --data-binary @site.zip -o response.json
        # extract CID using node (node is available on runner)
        node -e "const fs=require('fs'); const r=JSON.parse(fs.readFileSync('response.json','utf8')); if(!r || !r.value || !r.value.cid){ console.error('No CID in response', r); process.exit(2);} console.log('CID='+r.value.cid);" > cid.out
        CID=$(cat cid.out | sed 's/CID=//')
        echo "cid=$CID" >> $GITHUB_OUTPUT
        echo "Uploaded CID: $CID"
        echo "Preview URL: https://dweb.link/ipfs/$CID/"

    - name: Create GitHub issue with CID and Unstoppable instructions (no external action)
      env:
        CID: ${{ steps.upload.outputs.cid }}
        GITHUB_REPO: ${{ github.repository }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        if [ -z "$CID" ]; then echo "No CID found"; exit 1; fi
        echo "Creating issue for CID: $CID"
        python3 - <<PY
import os, json, urllib.request, sys
repo = os.environ['GITHUB_REPO']
token = os.environ['GITHUB_TOKEN']
cid = os.environ['CID']
title = f"IPFS deploy — new CID: {cid}"
body = f"""✅ New IPFS deploy completed.

IPFS CID: `{cid}`

Preview: https://dweb.link/ipfs/{cid}/

To update your Unstoppable domain (ilikefish.brave):
1. Login to https://unstoppabledomains.com → My Domains → click ilikefish.brave
2. Go to Website / Records → set IPFS / dweb.ipfs.hash (or 'Website (IPFS)') to:
   {cid}
3. Save / Publish and sign the transaction in your wallet.

After the transaction confirms, Brave and other UD-enabled resolvers will load https://ilikefish.brave from IPFS.
"""
data = json.dumps({"title": title, "body": body}).encode('utf-8')
req = urllib.request.Request(f"https://api.github.com/repos/{repo}/issues", data=data,
                             headers={"Authorization": f"token {token}", "Accept": "application/vnd.github+json"})
try:
    resp = urllib.request.urlopen(req)
    print("Issue created:", resp.read().decode())
except Exception as e:
    print("Failed to create issue:", e)
    sys.exit(1)
PY

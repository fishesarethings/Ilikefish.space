name: Upload repo root to IPFS (nft.storage) and create Issue with CID

on:
  push:
    branches: [ main ]

env:
  BUILD_DIR: '.'   # repo root

jobs:
  upload:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Optional build (run if package.json has build)
      run: |
        if [ -f package.json ] && grep -q "\"build\"" package.json; then
          npm ci
          npm run build
        fi

    - name: Zip repo root (exclude .git and workflow runs)
      run: |
        rm -f site.zip
        zip -r site.zip . -x "*.git*" ".github/actions/*" "node_modules/*" || true
        ls -lah site.zip

    - name: Upload site.zip to nft.storage
      id: upload
      env:
        NFT_TOKEN: ${{ secrets.NFT_STORAGE_API_KEY }}
      run: |
        if [ -z "$NFT_TOKEN" ]; then echo "Missing NFT_STORAGE_API_KEY secret"; exit 1; fi
        # upload zip to nft.storage and save response
        curl -s -X POST "https://api.nft.storage/upload" \
          -H "Authorization: Bearer $NFT_TOKEN" \
          --data-binary @site.zip -o response.json
        # extract CID using node (no extra deps)
        node -e "const fs=require('fs'); const r=JSON.parse(fs.readFileSync('response.json','utf8')); if(!r || !r.value || !r.value.cid){ console.error('No CID in response', r); process.exit(2);} console.log('CID='+r.value.cid);" > cid.out
        CID=$(cat cid.out | sed 's/CID=//')
        echo "cid=$CID" >> $GITHUB_OUTPUT
        echo "Uploaded CID: $CID"
        echo "Preview URL: https://dweb.link/ipfs/$CID/"

    - name: Create GitHub issue with CID and Unstoppable instructions
      uses: peter-evans/create-issue@v4
      with:
        title: "IPFS deploy — new CID: ${{ steps.upload.outputs.cid }}"
        body: |
          ✅ New IPFS deploy completed.

          **IPFS CID:** `${{ steps.upload.outputs.cid }}`

          Preview on gateway: `https://dweb.link/ipfs/${{ steps.upload.outputs.cid }}/`

          **To update your Unstoppable domain (`ilikefish.brave`)** (one small manual step):
          1. Login to https://unstoppabledomains.com → **My Domains** → click **ilikefish.brave**.  
          2. Go to **Website** / **Records**. Find **IPFS / dweb.ipfs.hash** (or "Website (IPFS)").  
          3. Paste this CID into the field:  
             ```
             ${{ steps.upload.outputs.cid }}
             ```
          4. Click **Save / Publish** and sign the transaction in your wallet when prompted.

          After the transaction is confirmed, Brave and other UD-enabled resolvers will load `https://ilikefish.brave` from IPFS (no redirect).

          — If you want fully automatic Unstoppable updates (zero clicks), reply "auto-UD" and I’ll give the secure workflow (requires a private key in GitHub Secrets).

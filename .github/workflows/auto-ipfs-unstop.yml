name: Auto-publish repo root to IPFS (nft.storage) and update Unstoppable

on:
  push:
    branches: [ main ]

env:
  DOMAIN: ilikefish.brave    # <-- keep this exact; change only if your UD is different
  BUILD_DIR: '.'             # repo root

jobs:
  publish-and-update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Optional build (run if package.json has build)
        run: |
          if [ -f package.json ] && grep -q "\"build\"" package.json; then
            npm ci
            npm run build
          fi

      - name: Zip repo root (exclude .git)
        run: |
          rm -f site.zip
          zip -r site.zip . -x "*.git*" "node_modules/*" ".github/actions/*" || true
          ls -lah site.zip

      - name: Upload site.zip to nft.storage
        id: upload
        env:
          NFT_TOKEN: ${{ secrets.NFT_STORAGE_API_KEY }}
        run: |
          if [ -z "$NFT_TOKEN" ]; then
            echo "Missing NFT_STORAGE_API_KEY secret"
            exit 1
          fi
          # upload zip
          curl -s -X POST "https://api.nft.storage/upload" \
            -H "Authorization: Bearer $NFT_TOKEN" \
            --data-binary @site.zip -o response.json
          # extract CID using node safely
          node -e "const fs=require('fs'); const r=JSON.parse(fs.readFileSync('response.json','utf8')); if(!r||!r.value||!r.value.cid){ console.error('No CID',JSON.stringify(r)); process.exit(2);} console.log(r.value.cid);" > cid.out
          CID=$(cat cid.out)
          echo "cid=$CID" >> $GITHUB_OUTPUT
          echo "Uploaded CID: $CID"
          echo "Preview URL: https://dweb.link/ipfs/$CID/"

      - name: Install node deps for update script
        run: |
          npm install axios ethers --no-audit --no-fund

      - name: Update Unstoppable domain record to new CID
        env:
          DOMAIN: ${{ env.DOMAIN }}
          CID: ${{ steps.upload.outputs.cid }}
          OWNER_ADDRESS: ${{ secrets.UD_OWNER_ADDRESS }}
          PRIVATE_KEY: ${{ secrets.UD_PRIVATE_KEY }}
        run: |
          echo "DOMAIN=$DOMAIN"
          echo "CID=$CID"
          if [ -z "$CID" ]; then
            echo "No CID - aborting"
            exit 1
          fi
          node .github/scripts/update-ud.js

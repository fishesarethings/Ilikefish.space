<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Idle Shop Keeper</title>
  <style>
    /* (Your CSS preserved with a few additions for small UI elements) */
    body {box-sizing:border-box;margin:0;padding:20px;font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;color:#333;}
    .game-container{max-width:1200px;margin:0 auto;background:white;border-radius:20px;padding:30px;box-shadow:0 20px 40px rgba(0,0,0,0.1)}
    .main-menu{text-align:center}
    .subtitle{color:#666;font-size:1.2rem;margin:10px 0 40px 0}
    .menu-options{max-width:600px;margin:0 auto}
    .menu-btn{width:100%;background:white;border:2px solid #e2e8f0;border-radius:15px;padding:20px;margin-bottom:15px;cursor:pointer;transition:all .3s ease;display:flex;align-items:center;gap:20px;text-align:left}
    .menu-btn:hover{border-color:#4299e1;transform:translateY(-2px);box-shadow:0 8px 25px rgba(66,153,225,.15)}
    .single-player{background:linear-gradient(135deg,#48bb78,#38a169);color:white;border-color:#38a169}
    .single-player:hover{background:linear-gradient(135deg,#38a169,#2f855a);border-color:#2f855a}
    .btn-icon{font-size:2.5rem;min-width:60px}
    .btn-text h3{margin:0 0 5px;font-size:1.2rem}
    .btn-text p{margin:0;color:#666;font-size:.9rem}
    .single-player .btn-text p{color:rgba(255,255,255,.8)}
    .status-indicator{margin-left:auto;font-size:.8rem;font-weight:bold}
    .multiplayer-section{margin-top:40px}
    .multiplayer-section h2{color:#4a5568;margin-bottom:20px;font-size:1.3rem}
    .header{text-align:center;margin-bottom:30px}
    .header h1{color:#4a5568;margin:0;font-size:2.5rem}
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px}
    .stat-card{background:linear-gradient(135deg,#48bb78,#38a169);color:white;padding:20px;border-radius:15px;text-align:center;box-shadow:0 4px 15px rgba(72,187,120,.3)}
    .stat-card h3{margin:0 0 10px;font-size:1.1rem;opacity:.9}
    .stat-value{font-size:2rem;font-weight:bold;margin:0}
    .game-sections{display:grid;grid-template-columns:1fr 1fr;gap:30px;margin-bottom:30px}
    .section{background:#f7fafc;border-radius:15px;padding:25px;border:2px solid #e2e8f0}
    .section h2{color:#2d3748;margin:0 0 20px;font-size:1.5rem;text-align:center}
    .inventory-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:15px}
    .item-card{background:white;border-radius:10px;padding:15px;text-align:center;border:2px solid #e2e8f0;transition:all .3s ease}
    .item-card:hover{transform:translateY(-2px);box-shadow:0 4px 15px rgba(0,0,0,.1)}
    .item-emoji{font-size:2rem;margin-bottom:8px}
    .item-name{font-weight:bold;margin-bottom:5px;font-size:.9rem}
    .item-count{color:#666;font-size:.8rem;margin-bottom:10px}
    .buy-btn,.upgrade-btn{background:linear-gradient(135deg,#4299e1,#3182ce);color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:.8rem;font-weight:bold;transition:all .3s ease;width:100%}
    .buy-btn:hover,.upgrade-btn:hover{background:linear-gradient(135deg,#3182ce,#2c5282);transform:translateY(-1px)}
    .buy-btn:disabled,.upgrade-btn:disabled{background:#cbd5e0;cursor:not-allowed;transform:none}
    .customer-queue{background:#fff5f5;border:2px solid #fed7d7;border-radius:12px;padding:20px;margin-bottom:20px}
    .customer{display:flex;align-items:center;justify-content:space-between;background:white;padding:15px;border-radius:8px;margin-bottom:10px;border:1px solid #e2e8f0}
    .customer-info{display:flex;align-items:center;gap:10px}
    .customer-emoji{font-size:1.5rem}
    .serve-btn{background:linear-gradient(135deg,#48bb78,#38a169);color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-weight:bold}
    .serve-btn:hover{background:linear-gradient(135deg,#38a169,#2f855a)}
    .serve-btn:disabled{background:#cbd5e0;cursor:not-allowed}
    .controls{display:flex;gap:10px;align-items:center;justify-content:center;margin-top:10px;flex-wrap:wrap}
    .small{font-size:.85rem;color:#555}
    /* small utilities */
    .player-code { font-size:0.9rem; color:#2d3748; background:#f7fafc; padding:6px 8px; border-radius:8px; border:1px solid #e2e8f0; display:inline-block; margin-left:8px; }
    .copy-btn { margin-left:8px; padding:6px 8px; border-radius:8px; border:none; cursor:pointer; background:#4299e1; color:white; }
    /* modal & toast (non-blocking, no native prompts) */
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; z-index:3000; }
    .modal { background:white; padding:18px; border-radius:12px; width:360px; max-width:94%; box-shadow:0 8px 40px rgba(0,0,0,0.25); }
    .modal h3{margin:0 0 8px 0; font-size:1.1rem; color:#2d3748}
    .input { width:100%; padding:8px 10px; border-radius:8px; border:1px solid #e2e8f0; }
    .btn { padding:8px 12px; border-radius:8px; border:none; cursor:pointer; }
    .btn.primary { background:#4299e1; color:white; }
    .btn.ghost { background:#e2e8f0; color:#2d3748; }
    #toastArea { position:fixed; right:18px; bottom:18px; display:flex; flex-direction:column; gap:8px; z-index:4000; }
    .toast { background:#2d3748; color:white; padding:8px 12px; border-radius:8px; opacity:0.95; min-width:160px; }
    @media(max-width:768px){ .game-sections{grid-template-columns:1fr} .stats{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="game-container">
    <!-- Main Menu -->
    <div id="mainMenu" class="main-menu">
      <div class="header">
        <h1>üè™ Idle Shop Keeper</h1>
        <p class="subtitle">Build your retail empire!</p>
        <div style="margin-top:12px">
          <span class="small">Your player code:</span>
          <span id="playerCode" class="player-code">‚Äî</span>
          <button id="copyPlayerCode" class="copy-btn">Copy</button>
        </div>
      </div>

      <div class="menu-options">
        <button class="menu-btn single-player" id="btnSingle">
          <div class="btn-icon">üéÆ</div>
          <div class="btn-text"><h3>Single Player</h3><p>Play solo and build your shop</p></div>
        </button>

        <div style="margin:10px 0; text-align:left">
          <strong>Friends & Recent</strong>
          <div style="display:flex;gap:10px;margin-top:8px;justify-content:center">
            <button id="btnFriends" class="menu-btn multiplayer">üë• Friends</button>
            <button id="btnRecent" class="menu-btn multiplayer">üïò Recent</button>
          </div>
        </div>

        <div class="multiplayer-section">
          <h2>üåê Multiplayer Options</h2>
          <button class="menu-btn multiplayer" id="btnLAN"><div class="btn-icon">üè†</div>
            <div class="btn-text"><h3>Local Network</h3><p>Play with friends on LAN</p></div></button>

          <button class="menu-btn multiplayer" id="btnRandom"><div class="btn-icon">üé≤</div>
            <div class="btn-text"><h3>Random Match</h3><p>Find a random opponent</p></div></button>

          <button class="menu-btn multiplayer" id="btnGlobal"><div class="btn-icon">üåç</div>
            <div class="btn-text"><h3>Global Match</h3><p>Worldwide players</p></div></button>
        </div>
      </div>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" style="display:none">
      <div class="header"><h1>üè™ Idle Shop Keeper</h1></div>

      <div class="stats">
        <div class="stat-card"><h3>üí∞ Money</h3><p class="stat-value" id="money">$100</p></div>
        <div class="stat-card"><h3>üë• Customers Served</h3><p class="stat-value" id="customersServed">0</p></div>
        <div class="stat-card"><h3>‚≠ê Shop Level</h3><p class="stat-value" id="shopLevel">1</p></div>
      </div>

      <div class="customer-queue"><h2>üö∂‚Äç‚ôÇÔ∏è Customer Queue</h2><div id="customerList"><p style="text-align:center;color:#666">No customers waiting...</p></div></div>

      <div class="game-sections">
        <div class="section"><h2>üì¶ Shop Inventory</h2><div class="inventory-grid" id="inventory"></div></div>
        <div class="section"><h2>üõí Buy Items</h2><div class="small" style="text-align:center">Unlocked: <span id="unlockedCount">6</span></div>
          <div class="inventory-grid" id="buySection"></div></div>
      </div>

      <div class="section"><h2>‚¨ÜÔ∏è Shop Upgrades</h2><div id="upgrades"></div>
        <div style="margin-top:20px"><h3>üõ†Ô∏è Workers</h3><div id="workersPanel"></div>
          <div class="controls">
            <button id="autosaveBtn" class="upgrade-btn">Autosave: ON</button>
            <button id="saveBtn" class="upgrade-btn">Save</button>
            <button id="exportBtn" class="upgrade-btn">Export Save</button>
            <input id="importFile" type="file" accept=".json" style="display:none" />
            <button id="importBtn" class="upgrade-btn">Import Save</button>
            <button id="savesBtn" class="upgrade-btn">Saves</button>
            <button id="exitSave" class="upgrade-btn">Exit (save)</button>
            <button id="exitNoSave" class="upgrade-btn" style="background:#e53e3e">Exit (no save)</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- modal root & toast area -->
  <div id="modalRoot" style="position:fixed;inset:0;pointer-events:none;z-index:3500"></div>
  <div id="toastArea"></div>

  <!-- Firebase + App Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, onChildAdded, child, get, remove, update } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js";

    // ---------- CONFIG: replace with your firebase config if different ----------
    const firebaseConfig = {
      apiKey: "AIzaSyBn4khIpi57YvqQX2urCup2mCvpVUZ0j8k",
      authDomain: "idle-shop-keeper.firebaseapp.com",
      databaseURL: "https://idle-shop-keeper-default-rtdb.firebaseio.com",
      projectId: "idle-shop-keeper",
      storageBucket: "idle-shop-keeper.firebasestorage.app",
      messagingSenderId: "117380146729",
      appId: "1:117380146729:web:8180d507d5a2aae45e5e38",
      measurementId: "G-VS2Z5T0Y9Y"
    };

    const app = initializeApp(firebaseConfig);
    try { getAnalytics(app); } catch(e) {}
    const db = getDatabase(app);
    const auth = getAuth(app);

    // ---------- small UI utilities (modals & toasts) ----------
    const modalRoot = document.getElementById('modalRoot');
    function showModal(html, opts = {}) {
      const backdrop = document.createElement('div'); backdrop.className = 'modal-backdrop';
      backdrop.style.pointerEvents = 'auto';
      const box = document.createElement('div'); box.className = 'modal'; box.innerHTML = html;
      backdrop.appendChild(box); modalRoot.appendChild(backdrop);
      function close() { try{ backdrop.remove(); } catch(e){} if (opts.onClose) opts.onClose(); }
      box.querySelectorAll('[data-close]').forEach(el=>el.addEventListener('click', close));
      return { close, box, backdrop };
    }
    function toast(msg, t=3000) {
      const area = document.getElementById('toastArea');
      const el = document.createElement('div'); el.className='toast'; el.textContent = msg;
      area.appendChild(el);
      setTimeout(()=> el.style.opacity='0', t-350);
      setTimeout(()=> { try{ el.remove(); } catch(e){} }, t);
    }

    // ---------- storage keys ----------
    const STORAGE_KEY = 'idle_shop_saves_v1';
    const META_KEY = 'idle_shop_meta_v1';

    // ---------- helpers ----------
    function safeParse(v, fallback) { try { return JSON.parse(v); } catch(e) { return fallback; } }
    function generateId() { if (crypto && crypto.randomUUID) return 'p-' + crypto.randomUUID(); return 'p-' + Math.random().toString(36).slice(2,10); }

    // ---------- game state (same structure as before) ----------
    let gameState = {
      money: 100,
      customersServed: 0,
      shopLevel: 1,
      inventory: {},
      upgrades: { autoCustomer:0, fasterService:0, betterPrices:0, moreCustomers:0 },
      customers: [],
      workers: { manager:{level:0,assigned:'idle'}, restocker:{level:0,assigned:'idle'}, server:{level:0,assigned:'idle'} },
      playerId: null,
      unlockedCount: 6,
      recentOpponents: [],
      friends: [],
      autosave: true
    };

    const TOTAL_ITEMS = 5000;
    const items = {};
    function generateItems() {
      const base = [
        { key:'apple', emoji:'üçé', name:'Apple', buyPrice:5, sellPrice:8 },
        { key:'bread', emoji:'üçû', name:'Bread', buyPrice:8, sellPrice:12 },
        { key:'milk', emoji:'ü•õ', name:'Milk', buyPrice:12, sellPrice:18 },
        { key:'candy', emoji:'üç¨', name:'Candy', buyPrice:15, sellPrice:25 },
        { key:'coffee', emoji:'‚òï', name:'Coffee', buyPrice:20, sellPrice:35 },
        { key:'cake', emoji:'üéÇ', name:'Cake', buyPrice:30, sellPrice:50 }
      ];
      base.forEach(it => { items[it.key] = it; gameState.inventory[it.key] = gameState.inventory[it.key] || 0; });
      for (let i = base.length + 1; i <= TOTAL_ITEMS; i++) {
        const key = 'item_' + i; const buy = 5 + Math.floor(i * 0.8); const sell = Math.floor(buy * 1.6);
        items[key] = { emoji:'üéÅ', name:'Item ' + i, buyPrice: buy, sellPrice: sell };
        gameState.inventory[key] = gameState.inventory[key] || 0;
      }
    }

    const upgradeDefinitions = {
      autoCustomer:{name:'Auto Customer',description:'Customers arrive automatically',baseCost:200},
      fasterService:{name:'Faster Service',description:'Serve customers 25% faster',baseCost:150},
      betterPrices:{name:'Better Prices',description:'Earn 20% more per sale',baseCost:300},
      moreCustomers:{name:'More Customers',description:'More customers in queue',baseCost:250}
    };
    const workerDefs = {
      manager:{name:'Manager',description:'Enable worker coordination; required to assign tasks',baseCost:500},
      restocker:{name:'Restocker',description:'Automatically restocks inventory when assigned',baseCost:300},
      server:{name:'Server',description:'Automatically serves customers when assigned',baseCost:350}
    };
    const customerTypes = [
      {emoji:'üë®', wants:['apple','bread']},
      {emoji:'üë©', wants:['milk','coffee']},
      {emoji:'üë¶', wants:['candy','cake']},
      {emoji:'üëß', wants:['apple','candy']},
      {emoji:'üßì', wants:['bread','milk']},
      {emoji:'üë¥', wants:['coffee','cake']}
    ];

    // ---------- UI updates ----------
    function updateStats() {
      document.getElementById('money').textContent = '$' + gameState.money;
      document.getElementById('customersServed').textContent = gameState.customersServed;
      document.getElementById('shopLevel').textContent = gameState.shopLevel;
      document.getElementById('unlockedCount').textContent = gameState.unlockedCount;
      const auto = document.getElementById('autosaveBtn'); if (auto) auto.textContent = 'Autosave: ' + (gameState.autosave ? 'ON' : 'OFF');
      const codeEl = document.getElementById('playerCode'); if (codeEl) codeEl.textContent = gameState.playerId || '‚Äî';
    }

    function updateInventory() {
      const inventoryDiv = document.getElementById('inventory'); inventoryDiv.innerHTML = '';
      const keys = Object.keys(items).slice(0, gameState.unlockedCount);
      keys.forEach(k => {
        const item = items[k]; const count = gameState.inventory[k] || 0;
        const div = document.createElement('div'); div.className = 'item-card';
        div.innerHTML = `<div class="item-emoji">${item.emoji}</div><div class="item-name">${item.name}</div><div class="item-count">Stock: ${count}</div>`;
        inventoryDiv.appendChild(div);
      });
    }

    function updateBuySection() {
      const buyDiv = document.getElementById('buySection'); buyDiv.innerHTML = '';
      const keys = Object.keys(items).slice(0, gameState.unlockedCount);
      keys.forEach(k => {
        const it = items[k];
        const card = document.createElement('div'); card.className = 'item-card';
        card.innerHTML = `<div class="item-emoji">${it.emoji}</div><div class="item-name">${it.name}</div><div class="item-count">$${it.buyPrice}</div><button class="buy-btn" data-key="${k}">Buy</button>`;
        buyDiv.appendChild(card);
      });
      buyDiv.querySelectorAll('.buy-btn').forEach(b => {
        const key = b.getAttribute('data-key'); b.disabled = gameState.money < items[key].buyPrice; b.onclick = () => buyItem(key);
      });
    }

    function updateUpgrades() {
      const u = document.getElementById('upgrades'); u.innerHTML = '';
      Object.keys(upgradeDefinitions).forEach(up => {
        const def = upgradeDefinitions[up]; const level = gameState.upgrades[up]; const cost = Math.floor(def.baseCost * Math.pow(1.5, level));
        const card = document.createElement('div'); card.className = 'upgrade-card'; card.innerHTML = `<h3>${def.name}</h3><div class="upgrade-description">${def.description}</div><div style="margin-bottom:10px;">Level: ${level}</div><div style="margin-bottom:15px;">Cost: $${cost}</div><button class="upgrade-btn" data-up="${up}">Upgrade</button>`;
        u.appendChild(card);
      });
      u.querySelectorAll('.upgrade-btn').forEach(btn => {
        const key = btn.getAttribute('data-up'); const level = gameState.upgrades[key]; const cost = Math.floor(upgradeDefinitions[key].baseCost * Math.pow(1.5, level));
        btn.disabled = gameState.money < cost; btn.onclick = () => buyUpgrade(key);
      });
      renderWorkersPanel();
    }

    function renderWorkersPanel() {
      const panel = document.getElementById('workersPanel'); panel.innerHTML = '';
      Object.keys(gameState.workers).forEach(wk => {
        const w = gameState.workers[wk]; const def = workerDefs[wk]; const cost = Math.floor(def.baseCost * Math.pow(1.6, w.level));
        const card = document.createElement('div'); card.className = 'upgrade-card'; card.innerHTML = `<h3>${def.name}</h3><div class="upgrade-description">${def.description}</div><div class="small">Level: ${w.level}</div><div class="small">Assigned: ${w.assigned}</div><div style="margin-top:8px;display:grid;gap:6px"><button class="upgrade-btn" data-buy="${wk}">Buy/Upgrade ($${cost})</button>${wk!=='manager'?`<select id="assign_${wk}"><option value="idle">Idle</option><option value="restock">Restock</option><option value="serve">Serve</option></select>`:`<select id="assign_${wk}"><option value="idle">Idle</option><option value="manage">Manage</option><option value="assign">Assign Tasks</option></select>`}</div>`;
        panel.appendChild(card);
        const buyBtn = card.querySelector('[data-buy]'); buyBtn.disabled = gameState.money < cost; buyBtn.onclick = () => upgradeWorker(wk);
        setTimeout(()=> { const sel = document.getElementById('assign_'+wk); if(sel){ sel.value = w.assigned; sel.onchange = () => assignWorker(wk, sel.value); } }, 10);
      });
    }

    function updateCustomers() {
      const list = document.getElementById('customerList'); list.innerHTML = '';
      if(gameState.customers.length === 0){ list.innerHTML = '<p style="text-align:center;color:#666">No customers waiting...</p>'; return; }
      gameState.customers.forEach((c,i) => {
        const item = items[c.wants]; const canServe = (gameState.inventory[c.wants]||0) > 0;
        const div = document.createElement('div'); div.className = 'customer';
        div.innerHTML = `<div class="customer-info"><span class="customer-emoji">${c.emoji}</span><span>Wants ${item.emoji} ${item.name} - $${item.sellPrice}</span></div><button class="serve-btn" data-i="${i}">${canServe ? 'Serve' : 'No Stock'}</button>`;
        list.appendChild(div);
        const btn = div.querySelector('.serve-btn'); btn.disabled = !canServe; btn.onclick = () => serveCustomer(i);
      });
    }

    // ---------- core actions ----------
    function buyItem(key) {
      const it = items[key]; if (gameState.money >= it.buyPrice) { gameState.money -= it.buyPrice; gameState.inventory[key] = (gameState.inventory[key]||0) + 1; updateAll(); }
    }
    function serveCustomer(idx) {
      const customer = gameState.customers[idx]; if(!customer) return;
      if((gameState.inventory[customer.wants]||0) > 0) {
        gameState.inventory[customer.wants]--; let earnings = items[customer.wants].sellPrice;
        if(gameState.upgrades.betterPrices > 0) earnings = Math.floor(earnings * (1 + 0.2 * gameState.upgrades.betterPrices));
        gameState.money += earnings; gameState.customersServed++; gameState.customers.splice(idx,1);
        if(gameState.customersServed % 10 === 0) { gameState.shopLevel++; gameState.unlockedCount = Math.min(TOTAL_ITEMS, gameState.unlockedCount + 10); }
        updateAll();
      }
    }
    function buyUpgrade(k) { const def = upgradeDefinitions[k]; const level = gameState.upgrades[k]; const cost = Math.floor(def.baseCost * Math.pow(1.5, level)); if(gameState.money >= cost){ gameState.money -= cost; gameState.upgrades[k]++; updateAll(); } }
    function upgradeWorker(k) { const def = workerDefs[k]; const level = gameState.workers[k].level; const cost = Math.floor(def.baseCost * Math.pow(1.6, level)); if(gameState.money >= cost){ gameState.money -= cost; gameState.workers[k].level++; updateAll(); } }
    function assignWorker(k, task){ if(gameState.workers.manager.level < 1 && k !== 'manager'){ toast('Manager required for automation'); const sel=document.getElementById('assign_'+k); if(sel) sel.value='idle'; return; } gameState.workers[k].assigned = task; updateAll(); }
    function spawnCustomer(){ const maxCustomers = 3 + gameState.upgrades.moreCustomers; if(gameState.customers.length < maxCustomers){ const ct = customerTypes[Math.floor(Math.random()*customerTypes.length)]; const want = ct.wants[Math.floor(Math.random()*ct.wants.length)]; gameState.customers.push({emoji:ct.emoji, wants:want}); updateCustomers(); } }
    function workerTick(){ const rest = gameState.workers.restocker; if(rest.level > 0 && rest.assigned === 'restock' && gameState.workers.manager.level > 0){ if(Math.random() < 0.3 + rest.level * 0.15){ const unlocked = Object.keys(items).slice(0, gameState.unlockedCount); let cheapest = unlocked[0]; unlocked.forEach(k => { if(items[k].buyPrice < items[cheapest].buyPrice) cheapest = k; }); const amount = 1 + rest.level; const cost = items[cheapest].buyPrice * amount; if(gameState.money >= cost){ gameState.money -= cost; gameState.inventory[cheapest] = (gameState.inventory[cheapest]||0) + amount; } } } const srv = gameState.workers.server; if(srv.level > 0 && srv.assigned === 'serve' && gameState.workers.manager.level > 0){ if(gameState.customers.length>0 && Math.random() < 0.4 + srv.level * 0.15){ for(let i=0;i<gameState.customers.length;i++){ const c = gameState.customers[i]; if((gameState.inventory[c.wants]||0) > 0){ serveCustomer(i); break; } } } } }
    function updateAll(){ updateStats(); updateInventory(); updateBuySection(); updateUpgrades(); updateCustomers(); try{ localStorage.setItem(META_KEY, JSON.stringify({ playerId: gameState.playerId, friends: gameState.friends, recent: gameState.recentOpponents })); }catch(e){} }

    // ---------- game loop ----------
    let gameLoopInterval = null;
    function gameLoop(){ if(gameState.upgrades.autoCustomer > 0 && Math.random() < 0.3 + (gameState.upgrades.autoCustomer * 0.1)) spawnCustomer(); if(Math.random() < 0.1 + (gameState.shopLevel * 0.02)) spawnCustomer(); workerTick(); if(gameState.autosave) quickSave(); }

    // ---------- saves: local + firebase mirror ----------
    function getSavesLocal(){ return safeParse(localStorage.getItem(STORAGE_KEY), {}); }
    function setSavesLocal(s){ try { localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); } catch(e) {} }

    async function saveToSlot(slotName) {
      const name = slotName || ('save-' + new Date().toISOString().slice(0,19).replace(/[:T]/g,'-'));
      const saves = getSavesLocal(); saves[name] = { state: JSON.parse(JSON.stringify(gameState)), ts: Date.now() };
      setSavesLocal(saves);
      // mirror to firebase
      try {
        if(gameState.playerId) await set(ref(db, `players/${gameState.playerId}/saves/${name}`), saves[name]);
        toast('Saved: ' + name);
      } catch(e){ toast('Saved locally (firebase failed)'); }
    }

    async function loadFromSlot(slotName) {
      const saves = getSavesLocal();
      if(saves[slotName]) {
        gameState = JSON.parse(JSON.stringify(saves[slotName].state));
        postLoadRestore();
        toast('Loaded: ' + slotName);
        return;
      }
      // firebase fallback
      try {
        if(gameState.playerId) {
          const snap = await get(ref(db, `players/${gameState.playerId}/saves/${slotName}`));
          if(snap.exists()) {
            const payload = snap.val();
            gameState = JSON.parse(JSON.stringify(payload.state));
            postLoadRestore();
            toast('Loaded from server: ' + slotName);
            return;
          }
        }
      } catch(e){}
      toast('Save not found: ' + slotName);
    }

    function postLoadRestore() {
      generateItems(); gameState.inventory = gameState.inventory || {}; gameState.upgrades = gameState.upgrades || { autoCustomer:0,fasterService:0,betterPrices:0,moreCustomers:0 };
      gameState.workers = gameState.workers || { manager:{level:0,assigned:'idle'}, restocker:{level:0,assigned:'idle'}, server:{level:0,assigned:'idle'} };
      gameState.recentOpponents = gameState.recentOpponents || []; gameState.friends = gameState.friends || [];
      updateAll();
    }

    function openSaveManager() {
      const saves = getSavesLocal(); const keys = Object.keys(saves);
      const content = `<h3>Saved slots</h3><div style="max-height:260px;overflow:auto;margin-top:8px">${keys.map(k=>`<div style="display:flex;gap:8px;align-items:center;margin:6px 0"><div style="flex:1"><strong>${k}</strong><div class="small" style="color:#666">${new Date(saves[k].ts).toLocaleString()}</div></div><div style="display:flex;gap:6px"><button class="btn primary" data-load="${k}">Load</button><button class="btn ghost" data-del="${k}">Delete</button></div></div>`).join('') || '<div class="small" style="color:#666">No saves</div>'}</div><div style="text-align:right;margin-top:10px"><button class="btn ghost" data-close>Close</button></div>`;
      const modal = showModal(content);
      modal.box.querySelectorAll('[data-load]').forEach(b => b.addEventListener('click', () => { const k = b.getAttribute('data-load'); modal.close(); loadFromSlot(k); }));
      modal.box.querySelectorAll('[data-del]').forEach(b => b.addEventListener('click', () => { const k = b.getAttribute('data-del'); delete saves[k]; setSavesLocal(saves); toast('Deleted ' + k); modal.close(); }));
    }

    function quickSave() {
      try {
        const saves = getSavesLocal(); const key = 'quick_' + gameState.playerId;
        saves[key] = { state: JSON.parse(JSON.stringify(gameState)), ts: Date.now() };
        setSavesLocal(saves);
        if(gameState.playerId) set(ref(db, `players/${gameState.playerId}/saves/${key}`), saves[key]).catch(()=>{});
      } catch(e){}
    }

    function toggleAutoSave() { gameState.autosave = !gameState.autosave; updateStats(); toast('Autosave ' + (gameState.autosave ? 'ON' : 'OFF')); }

    // ---------- export / import ----------
    function exportSave() {
      const exportObj = { savedAt: Date.now(), playerId: gameState.playerId, state: gameState };
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportObj, null, 2));
      const a = document.createElement('a'); a.href = dataStr; a.download = `idle-shop-${gameState.playerId || 'anon'}-${new Date().toISOString().slice(0,19)}.json`; document.body.appendChild(a); a.click(); a.remove();
      toast('Export started');
    }

    function importSaveFromFile(file) {
      if(!file) { toast('No file selected'); return; }
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const payload = JSON.parse(e.target.result);
          if(!payload || !payload.state) { toast('Invalid save file'); return; }
          // apply loaded state
          gameState = payload.state;
          postLoadRestore();
          toast('Imported save');
          // optionally mirror to local & firebase quick slot
          const saves = getSavesLocal(); const key = 'import_' + (payload.playerId || 'import') + '_' + Date.now();
          saves[key] = { state: JSON.parse(JSON.stringify(gameState)), ts: Date.now() }; setSavesLocal(saves);
          if(gameState.playerId) set(ref(db, `players/${gameState.playerId}/saves/${key}`), saves[key]).catch(()=>{});
        } catch(e) { console.warn(e); toast('Failed to import'); }
      };
      reader.readAsText(file);
    }

    // ---------- friends & recent, presence ----------
    async function pushMetaToFirebase() {
      if(!gameState.playerId) return;
      try { await set(ref(db, `players/${gameState.playerId}/meta`), { friends: gameState.friends, recent: gameState.recentOpponents, lastSeen: Date.now() }); } catch(e) {}
    }
    function addRecentOpponent(id) { if(!id) return; gameState.recentOpponents.unshift(id); gameState.recentOpponents = [...new Set(gameState.recentOpponents)].slice(0,20); try{ localStorage.setItem(META_KEY, JSON.stringify({ playerId: gameState.playerId, friends: gameState.friends, recent: gameState.recentOpponents })); }catch(e){} pushMetaToFirebase(); }
    function addFriendId(id) { if(!id) return; gameState.friends.unshift(id); gameState.friends = [...new Set(gameState.friends)].slice(0,50); try{ localStorage.setItem(META_KEY, JSON.stringify({ playerId: gameState.playerId, friends: gameState.friends, recent: gameState.recentOpponents })); }catch(e){} pushMetaToFirebase(); }

    // ---------- UI modal helpers for adding friend and showing recent ----------
    function openFriendsModal() {
      const content = `<h3>Friends</h3><div style="margin-top:8px"><input id="friendAdd" class="input" placeholder="Enter player code to add" /></div><div style="display:flex;gap:8px;margin-top:8px"><button id="addFriendOk" class="btn primary">Add</button><button class="btn ghost" data-close>Close</button></div><div style="margin-top:10px"><h4>Your friends</h4><div style="max-height:160px;overflow:auto">${gameState.friends.map(f=>`<div style="padding:6px 0">${f}</div>`).join('') || '<div class="small" style="color:#666">No friends</div>'}</div></div>`;
      const modal = showModal(content);
      modal.box.querySelector('#addFriendOk').addEventListener('click', () => {
        const v = modal.box.querySelector('#friendAdd').value.trim(); if(!v) { toast('Enter a player code'); return; }
        addFriendId(v); modal.close(); toast('Friend added');
      });
    }
    function openRecentModal() {
      const content = `<h3>Recent Opponents</h3><div style="max-height:240px;overflow:auto;margin-top:8px">${gameState.recentOpponents.map(r=>`<div style="padding:6px 0">${r}</div>`).join('') || '<div class="small" style="color:#666">No recent opponents</div>'}</div><div style="text-align:right;margin-top:10px"><button class="btn ghost" data-close>Close</button></div>`;
      showModal(content);
    }

    // ---------- presence & available players listing ----------
    async function writePresence() {
      if(!gameState.playerId) return;
      try {
        await set(ref(db, `players/${gameState.playerId}/presence`), { lastSeen: Date.now(), playerId: gameState.playerId });
      } catch(e){ console.warn('presence write failed', e); }
    }

    function listenForPlayers() {
      const panel = document.createElement('div'); // we will render into modal when requested
      // Listen to entire players node
      onValue(ref(db, 'players'), snapshot => {
        const all = snapshot.val() || {};
        // update nothing in main UI automatically; we present when user opens friends modal or invites
      });
    }

    // ---------- minimal WebRTC signaling (room creation/join UI) ----------
    // For simplicity we keep the same Firebase rooms structure as before: rooms/{roomId}/{offer,answer,candidates}
    let pc = null, currentRoom = null;

    async function createRoomAndShow() {
      const rid = Math.random().toString(36).slice(2,10);
      try {
        await set(ref(db, `rooms/${rid}`), { createdAt: Date.now(), host: gameState.playerId });
        toast('Room created: ' + rid);
        showModal(`<h3>Room Created</h3><div style="margin-top:8px"><div class="small" style="color:#666">Share this room ID with another player to join:</div><div style="margin-top:8px;padding:8px;border-radius:8px;background:#f7fafc;border:1px solid #e2e8f0;text-align:center;font-weight:bold">${rid}</div></div><div style="text-align:right;margin-top:10px"><button class="btn ghost" data-close>Close</button></div>`);
        // (Signaling steps to create offer are handled when peer connection used; left minimal to not bloat)
      } catch(e) { console.warn(e); toast('Failed to create room'); }
    }

    async function joinRoomByIdModal() {
      const nm = 'roomInput_' + Math.random().toString(36).slice(2,6);
      const content = `<h3>Join Room</h3><div style="margin-top:8px"><input id="${nm}" class="input" placeholder="Enter room ID" /></div><div style="display:flex;gap:8px;margin-top:8px"><button class="btn primary" id="joinRoomOk">Join</button><button class="btn ghost" data-close>Close</button></div>`;
      const m = showModal(content);
      m.box.querySelector('#joinRoomOk').addEventListener('click', async () => {
        const rid = m.box.querySelector('#'+nm).value.trim(); if(!rid){ toast('Enter room ID'); return; }
        m.close(); await joinRoomById(rid);
      });
    }

    async function joinRoomById(rid) {
      try {
        const offerSnap = await get(child(ref(db), `rooms/${rid}/offer`));
        if(!offerSnap.exists()){ toast('No active offer in room'); return; }
        toast('Joined room: ' + rid);
        // further handling would set up WebRTC; keep minimal for now
      } catch(e) { console.warn(e); toast('Failed to join room'); }
    }

    // ---------- UI wiring ----------
    document.getElementById('btnSingle').addEventListener('click', startSinglePlayer);
    document.getElementById('btnFriends').addEventListener('click', openFriendsModal);
    document.getElementById('btnRecent').addEventListener('click', openRecentModal);
    document.getElementById('btnLAN').addEventListener('click', () => createRoomAndShow());
    document.getElementById('btnRandom').addEventListener('click', () => { /* randomMatch implementation could go here */ toast('Random match coming soon'); });
    document.getElementById('btnGlobal').addEventListener('click', () => joinRoomByIdModal());

    document.getElementById('copyPlayerCode').addEventListener('click', () => {
      const code = gameState.playerId || '';
      if(!code) { toast('Player code not ready'); return; }
      navigator.clipboard?.writeText(code).then(()=>toast('Player code copied')).catch(()=>toast('Copy failed'));
    });

    document.getElementById('autosaveBtn').addEventListener('click', () => toggleAutoSave());
    document.getElementById('saveBtn').addEventListener('click', () => saveToSlot());
    document.getElementById('savesBtn').addEventListener('click', () => openSaveManager());
    document.getElementById('exportBtn').addEventListener('click', () => exportSave());
    document.getElementById('importBtn').addEventListener('click', () => document.getElementById('importFile').click());
    document.getElementById('importFile').addEventListener('change', (e) => {
      const f = e.target.files && e.target.files[0]; importSaveFromFile(f);
      e.target.value = '';
    });

    document.getElementById('exitSave').addEventListener('click', () => { saveToSlot(); exitToMenu(true); });
    document.getElementById('exitNoSave').addEventListener('click', () => exitToMenu(false));

    function saveToSlot() { saveToSlotUI(); }
    async function saveToSlotUI() { await saveToSlot(); } // alias kept for button

    function exitToMenu(save=true) {
      if(save) saveToSlot();
      document.getElementById('gameScreen').style.display = 'none'; document.getElementById('mainMenu').style.display = 'block';
      if(gameLoopInterval) { clearInterval(gameLoopInterval); gameLoopInterval = null; }
      toast('Returned to menu');
    }

    // ---------- anonymous auth & initialization ----------
    // Sign in anonymously so DB rules requiring auth work without an explicit login UI
    signInAnonymously(auth).catch(err => {
      console.warn('anonymous sign-in failed', err);
      toast('Anonymous sign-in failed (check Firebase config/rules)');
    });

    onAuthStateChanged(auth, (user) => {
      if(user) {
        // use auth.uid as part of playerId (keeps IDs stable across devices/browsers for the same anonymous user)
        if(!gameState.playerId) gameState.playerId = 'p-' + user.uid;
        // If playerId already present (local), keep it (this prevents overwriting manually created ids)
        if(!localStorage.getItem(META_KEY)) localStorage.setItem(META_KEY, JSON.stringify({ playerId: gameState.playerId, friends: [], recent: [] }));
        // write presence & meta
        writePresence();
        pushMetaToFirebase();
        // update UI
        updateStats();
      } else {
        // not signed in yet
      }
    });

    // load meta from localStorage if present
    try {
      const meta = safeParse(localStorage.getItem(META_KEY), {});
      if(meta && meta.playerId) gameState.playerId = meta.playerId;
      gameState.friends = meta.friends || gameState.friends;
      gameState.recentOpponents = meta.recent || gameState.recentOpponents;
    } catch(e){}

    // ensure id
    if(!gameState.playerId) { gameState.playerId = generateId(); try{ localStorage.setItem(META_KEY, JSON.stringify({ playerId: gameState.playerId, friends: gameState.friends, recent: gameState.recentOpponents })); }catch(e){} }

    // initial items and ui
    generateItems(); updateAll();

    // presence heartbeat
    setInterval(() => { writePresence(); }, 15000);

    // start single player (called from button)
    function startSinglePlayer() {
      document.getElementById('mainMenu').style.display = 'none'; document.getElementById('gameScreen').style.display = 'block';
      generateItems(); updateAll();
      if(gameLoopInterval) clearInterval(gameLoopInterval);
      gameLoopInterval = setInterval(gameLoop, 2000);
      setTimeout(() => spawnCustomer(), 1000);
      pushMetaToFirebase();
      toast('Single player started');
    }

    // expose small debug handles (optional)
    window.exportSave = exportSave;
    window.importSaveFromFile = importSaveFromFile;
    window.gameState = gameState;

  </script>
</body>
</html>
